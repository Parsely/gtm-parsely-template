___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Parse.ly",	
  "categories": ["ANALYTICS"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Load the Parse.ly tracker, set up custom audience segments, implement conversion events, and more, with the Parse.ly GTM tag template.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "type",
    "displayName": "Tag type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "tracker",
        "displayValue": "Tracker"
      },
      {
        "value": "conversion",
        "displayValue": "Conversion tracking"
      },
      {
        "value": "dynamic",
        "displayValue": "Dynamic tracking"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "tracker"
  },
  {
    "type": "TEXT",
    "name": "parselySiteId",
    "displayName": "Parse.ly Site ID",
    "simpleValueType": true,
    "help": "Find your Site ID in your Parse.ly dashboard URL (dash.parsely.com/{Site ID}/) or contact support@parsely.com.",
    "valueHint": "mysite.com",
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY",
        "errorMessage": "A Site ID is required to load the Parse.ly tracker."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "tracker",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "audienceSegmentsGroup",
    "displayName": "Custom Audience Segments",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "audienceSegments",
        "displayName": "Segment data",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Key",
            "name": "key",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "isUnique": true
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "help": "Enter the key/value pair(s) that Parse.ly will use to build your custom audience segments. \u003ca href\u003d\"https://docs.parse.ly/audience-segments-setup\"\u003eLearn more\u003c/a\u003e"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "tracker",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "additionalFeaturesGroup",
    "displayName": "Additional Features",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "disableAutotrack",
        "checkboxText": "Disable autotracking",
        "simpleValueType": true,
        "help": "Select this option to prevent pageviews from firing when the tracker loads. Pageviews can be manually sent with the Parse.ly Dynamic Tracking tag."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "tracker",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "conversionType",
    "displayName": "Conversion Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "trackSubscription",
        "displayValue": "Subscription"
      },
      {
        "value": "trackNewsletterSignup",
        "displayValue": "Newsletter Signup"
      },
      {
        "value": "trackLeadCapture",
        "displayValue": "Lead Capture"
      },
      {
        "value": "trackLinkClick",
        "displayValue": "Link Click"
      },
      {
        "value": "trackPurchase",
        "displayValue": "Purchase"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ],
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Choose the category of the conversion event. \u003ca href\u003d\"https://docs.parse.ly/conversions/#h-type\"\u003eLearn more\u003c/a\u003e",
    "notSetText": "(choose conversion type)"
  },
  {
    "type": "TEXT",
    "name": "conversionLabel",
    "displayName": "Conversion Label",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ],
    "help": "Identify the specific action taken by a user. Labels appear in the reporting suite, so spaces and capitalization are supported."
  },
  {
    "type": "TEXT",
    "name": "url",
    "displayName": "Page URL",
    "simpleValueType": true,
    "help": "Enter the URL of the page being viewed.",
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "dynamic",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "urlref",
    "displayName": "Referring URL",
    "simpleValueType": true,
    "help": "Enter the referring URL for the page being viewed.",
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "dynamic",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const query = require('queryPermission');
const injectScript = require('injectScript');
const encodeUriComponent = require('encodeUriComponent');
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const callInWindow = require('callInWindow');

log('data =', data);

if (data.type == 'tracker') {
  const parselySiteId = encodeUriComponent(data.parselySiteId);
  const parselyUrl = 'https://cdn.parsely.com/keys/' + parselySiteId + '/p.js?gtm_ver=3.0';
  
  // return or create new PARSELY object
  const getPARSELY = function() {
    const PARSELY = copyFromWindow('PARSELY');
    if (PARSELY) {
      return PARSELY;
    } else {
      return {};
    }
  };
  
  const parselySuccess = function() {
    log('PARSE.LY: tracker loaded for ', parselySiteId);
    
    // load audience segment data and call pageview (if 'Disable autotrack' is not selected)
    if (data.audienceSegments) {
      
      let segmentData = {};
      for (let i = 0; i < data.audienceSegments.length; i++) {
        segmentData[data.audienceSegments[i].key] = data.audienceSegments[i].value;
      }
      
      callInWindow('PARSELY.updateDefaults', {
        data: segmentData
      });
      
      if (!data.disableAutotrack) {
        callInWindow('PARSELY.beacon.trackPageView', {
          js: 1
        });
      }
    }
    
    data.gtmOnSuccess();
  };
  
  const parselyFailure = function() {
    log("PARSE.LY: Unable to load tracker");
    data.gtmOnFailure(); 
  };
  
  // disable autotracking if user selects the 'Disable autotrack' or 'Custom Audience Segments' are enabled
  if (data.disableAutotrack || data.audienceSegments) {
    let PARSELY = getPARSELY();
    PARSELY.autotrack = false;
    setInWindow('PARSELY', PARSELY, true);
  } 
  
  // inject tracking script
  if (query('inject_script', parselyUrl)) {
    injectScript(parselyUrl, parselySuccess, parselyFailure, 'parsely');
  } else {
    data.gtmOnFailure();
  }

} else if (data.type == 'conversion') {

  const parselyTrackingCall = 'PARSELY.conversions.' + data.conversionType;

  if (copyFromWindow(parselyTrackingCall)) {

    // fire a conversion event
    callInWindow(parselyTrackingCall, data.conversionLabel);
    log('PARSE.LY: ' + data.conversionType.substring(5) + ' conversion sent with "' + data.conversionLabel + '" label');
    data.gtmOnSuccess();

  } else {

    log('PARSE.LY: Conversions not enabled - please contact support@parsely.com');
    data.gtmOnFailure();

  }

} else if (data.type == 'dynamic') {

  // fire a pageview
  callInWindow('PARSELY.beacon.trackPageView', {
    url: data.url,
    urlref: data.urlref,
    js: 1
  });
  log('PARSE.LY: Pageview sent with custom values');
  data.gtmOnSuccess();
  
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn.parsely.com/keys/*/p.js?gtm_ver\u003d3.0"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "PARSELY"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "PARSELY.autotrack"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "PARSELY.updateDefaults"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "PARSELY.beacon.trackPageView"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "PARSELY.conversions.trackLeadCapture"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "PARSELY.conversions.trackNewsletterSignup"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "PARSELY.conversions.trackSubscription"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "PARSELY.conversions.trackPurchase"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "PARSELY.conversions.trackLinkClick"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Quick Test
  code: runCode();
setup: ''


___NOTES___

Created on 28/03/2023, 17:11:48


